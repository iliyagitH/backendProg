import socket
import threading

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
HOST = '127.0.0.1'  # –õ–æ–∫–∞–ª—å–Ω—ã–π IP-–∞–¥—Ä–µ—Å (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ)
PORT = 65432        # –ü–æ—Ä—Ç > 1024 (—á—Ç–æ–±—ã –Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
BUFFER_SIZE = 1024  # –†–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

def handle_client(conn, addr):
    """–§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    print(f"‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {addr}")
    
    with conn: # conn - —ç—Ç–æ —Å–æ–∫–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–µ–π accept()
        # 4. –ü—Ä–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        while True:
            data = conn.recv(BUFFER_SIZE) # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
            if not data:
                break # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (–∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è), –≤—ã—Ö–æ–¥–∏–º
            
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –≤—ã–≤–æ–¥–∞
            message = data.decode('utf-8') 
            print(f"‚úâÔ∏è –ü–æ–ª—É—á–µ–Ω–æ –æ—Ç {addr}: {message}")
            
            # 5. –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
            response = f"–°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∏–ª: {message.upper()}"
            conn.sendall(response.encode('utf-8')) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç

    print(f"‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: {addr}")

def start_server():
    # 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–∫–µ—Ç–∞
    # AF_INET - IPv4, SOCK_STREAM - TCP (–ø–æ—Ç–æ–∫–æ–≤—ã–π —Å–æ–∫–µ—Ç)
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        
        # 2. –ü—Ä–∏–≤—è–∑–∫–∞ (bind)
        s.bind((HOST, PORT))
        print(f"üåê –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ {HOST}:{PORT}")
        
        # 3. –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ (listen)
        # 5 - —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ –æ—á–µ—Ä–µ–¥–∏
        s.listen(5)
        print("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (listen)...")
        
        while True:
            # 4. –ü—Ä–∏–Ω—è—Ç–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (accept)
            # conn - –Ω–æ–≤—ã–π —Å–æ–∫–µ—Ç –¥–ª—è –æ–±–º–µ–Ω–∞, addr - –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
            conn, addr = s.accept()
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, 
            # —á—Ç–æ–±—ã –°–µ—Ä–≤–µ—Ä –º–æ–≥ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (accept)
            client_thread = threading.Thread(target=handle_client, args=(conn, addr))
            client_thread.start()

if __name__ == "__main__":
    start_server()